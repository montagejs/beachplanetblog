require("runtime/dependencies/gl-matrix");var Base=require("runtime/base").Base,Transform=require("runtime/transform").Transform,Utilities=require("runtime/utilities").Utilities,glTFNode=exports.glTFNode=Object.create(Base,{currentId:{value:0,writable:!0},bumpId:{value:function(){return glTFNode._id++}},_children:{value:null,writable:!0},children:{get:function(){return this._children},set:function(e){this._children=e}},_id:{value:null,writable:!0},id:{get:function(){return this._id},set:function(e){this._id=e}},_hidden:{value:null,writable:!0},hidden:{get:function(){return this._hidden},set:function(e){this._hidden=e}},_computeBBOXIfNeeded:{enumerable:!1,value:function(){if(!this._boundingBox){this._properties.meshes;var e=this.meshes.length;if(e>0){var t=this.meshes[0].boundingBox;if(t){var n;for(n=1;e>n;n++){var i=this.meshes[n].boundingBox;i&&(t=Utilities.mergeBBox(t,i))}this._boundingBox=t}}}}},getBoundingBox:{value:function(e){if(e){var t=mat4.identity(),n=this.boundingBox;return this.apply(function(e,t,i){var r=mat4.create();if(mat4.multiply(i,e.transform.matrix,r),e.boundingBox){var a=Utilities.transformBBox(e.boundingBox,r);n?e.meshes&&e.meshes.length>0&&(n=Utilities.mergeBBox(a,n)):n=a}return r},!0,t),n}return this.boundingBox}},_boundingBox:{enumerable:!1,value:null,writable:!0},boundingBox:{enumerable:!0,get:function(){return this._computeBBOXIfNeeded(),this._boundingBox},set:function(e){this._boundingBox=e}},meshesDidChange:{value:function(){this._boundingBox=null}},nodesDidChange:{value:function(){}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent}},init:{value:function(){this.__Base_init(),this._children=[],this.transform=Object.create(Transform).init(),this._properties.meshes=[];var e=this;return this._properties.meshes.push=function(t){var n=Array.prototype.push.call(this,t);return e.meshesDidChange(this),n},this._children.push=function(t){var n=Array.prototype.push.call(this,t);return t._parent=e,e.nodesDidChange(this),n},this._properties.cameras=[],this._properties.lights=[],this._worldMatrixIsDirty=!0,this._worldMatrix=mat4.create(),this}},initWithID:{value:function(e){return this.id=null==e?this.id+"-"+this.bumpId():e,this.init()}},getPropertyArrayNamed:{value:function(e){return this._properties[e]}},_observers:{value:null,writable:!0},addObserver:{value:function(e){null==this._observers&&(this._observers=[]),-1===this._observers.indexOf(e)?this._observers.push(e):console.log("WARNING attempt to add 2 times the same observer in transform")}},removeObserver:{value:function(e){if(this._observers){var t=this._observers.indexOf(e);-1!==t&&this._observers.splice(t,1)}}},_transform:{value:null,writable:!0},transform:{get:function(){if(this.target){var e=this.target.worldMatrix,t=this._transform.translation,n=vec3.create(),i=[0,1,0];Utilities.decomposeMat4(e,n,null,null);var r=mat4.lookAt(t,n,i);mat4.inverse(r);var a=Object.create(Transform).init();a.matrix=r,this._transform.rotation=a.rotation}return this._transform},set:function(e){if(this._observers)for(var t=0;this._observers.length>t;t++)this._observers[t].transformWillChange(this,this._transform,e);if(this._transform&&this._transform.removeObserver(this),this._transform=e,this._invalidateWorldMatrix(),this._transform&&this._transform.addObserver(this),this._observers)for(var t=0;this._observers.length>t;t++)this._observers[t].transformDidChange(this)}},meshes:{get:function(){return this.getPropertyArrayNamed("meshes")},set:function(e){this._properties.meshes=e,this.meshesDidChange(e)}},cameras:{get:function(){return this.getPropertyArrayNamed("cameras")},set:function(e){this._properties.cameras=e}},lights:{get:function(){return this.getPropertyArrayNamed("lights")},set:function(e){this._properties.lights=e}},_apply:{value:function(e,t,n,i){e&&(i=e(this,n,i),t&&this.children.forEach(function(n){n._apply(e,t,this,i)},this))}},apply:{value:function(e,t,n){this._apply(e,t,null,n)}},_nodeWithName:{value:function(e){if(this.name===e)return this;if(this.children)for(var t=0;this.children.length>t;t++){var n=this.children[t],i=n._nodeWithName(e);if(i)return i}return null}},nodeWithName:{value:function(e){return this._nodeWithName(e)}},_nodeWithID:{value:function(e){if(this.id===e)return this;if(this.children)for(var t=0;this.children.length>t;t++){var n=this.children[t],i=n._nodeWithID(e);if(i)return i}return null}},nodeWithJointID:{value:function(e){return this._nodeWithJointID(e)}},_nodeWithJointID:{value:function(e){if(this.jointId===e)return this;if(this.children)for(var t=0;this.children.length>t;t++){var n=this.children[t],i=n._nodeWithJointID(e);if(i)return i}return null}},nodeWithID:{value:function(e){return this._nodeWithID(e)}},copy:{value:function(e){var e=Object.create(glTFNode).init();e.name=this.name,this.meshes&&this.meshes.forEach(function(t){e.meshes.push(t)},this),this.lights&&this.lights.forEach(function(t){e.lights.push(t)},this),this.cameras&&this.cameras.forEach(function(t){e.cameras.push(t)},this);var t=this.bumpId();return e.id=this.id+"-"+t,e.baseId=this.baseId+"-"+t,e.transform=this.transform.copy(),e}},_worldMatrixIsDirty:{value:!0,writable:!0},_worldMatrix:{value:null,writable:!0},_offsetTransform:{value:null,writable:!0},_originVector:{value:null,writable:!0},worldMatrix:{get:function(){if(this.parent){if((this._worldMatrixIsDirty||null!=this.target)&&(mat4.multiply(this.parent.worldMatrix,this.transform.matrix,this._worldMatrix),this._worldMatrixIsDirty=!1),null!=this._offsetTransform){var e=this.getBoundingBox(!1);if(null!=e){mat4.create();var t=mat4.identity(),n=mat4.create(),i=vec3.createFrom(.5,.5,.5);null!=this._originVector&&(i[0]=this._originVector[0]/100,i[1]=this._originVector[1]/100,i[2]=this._originVector[2]/100);var r=[(e[0][0]+e[1][0])*i[0],(e[0][1]+e[1][1])*i[1],(e[0][2]+e[1][2])*i[2]],a=vec3.create(r);return mat4.translate(t,a),mat4.multiply(t,this._offsetTransform.matrix,n),mat4.multiply(this._worldMatrix,n,t),a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],mat4.translate(t,a),t}}return this._worldMatrix}return this._worldMatrixIsDirty=!1,this.transform.matrix}},_ignoresTransformUpdates:{value:!1,writable:!0},_invalidateWorldMatrix:{value:function(){if(this._worldMatrixIsDirty=!0,this._ignoresTransformUpdates=!0,this._transform._fireTransformDidUpdate(),this._ignoresTransformUpdates=!1,this._children)for(var e=0;this._children.length>e;e++)this._children[e]._invalidateWorldMatrix()}},transformDidUpdate:{value:function(){this._ignoresTransformUpdates===!1&&this._invalidateWorldMatrix()}},nodeWithJointID:{value:function(e){return this._nodeWithJointID(e)}},nodeWithPropertyNamed:{value:function(e){if(null!=this[e])return this;if(this.children)for(var t=0;this.children.length>t;t++){var n=this.children[t],i=n.nodeWithPropertyNamed(e);if(i)return i}return null}},_target:{value:null,writable:!0},target:{get:function(){return this._target},set:function(e){this._target=e}}});