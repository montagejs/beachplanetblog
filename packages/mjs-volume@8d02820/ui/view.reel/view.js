require("runtime/dependencies/gl-matrix");var Montage=require("montage").Montage,Component=require("montage/ui/component").Component,GLSLProgram=require("runtime/glsl-program").GLSLProgram,ResourceManager=require("runtime/helpers/resource-manager").ResourceManager,glTFScene=require("runtime/glTF-scene").glTFScene,glTFNode=require("runtime/glTF-node").glTFNode,Scene=require("runtime/scene").Scene,Node=require("runtime/node").Node,SceneRenderer=require("runtime/scene-renderer").SceneRenderer,glTFMaterial=require("runtime/glTF-material").glTFMaterial,Utilities=require("runtime/utilities").Utilities,dom=require("montage/core/dom"),Point=require("montage/core/geometry/point").Point,TranslateComposer=require("montage/composer/translate-composer").TranslateComposer,BuiltInAssets=require("runtime/builtin-assets").BuiltInAssets,WebGLRenderer=require("runtime/webgl-renderer").WebGLRenderer,URL=require("montage/core/url"),Projection=require("runtime/projection").Projection,BasicAnimation=require("runtime/animation").BasicAnimation,Camera=require("runtime/camera").Camera,BBox=require("runtime/utilities").BBox,SceneHelper=require("runtime/scene-helper").SceneHelper,CameraController=require("controllers/camera-controller").CameraController,Transform=require("runtime/transform").Transform,Component3D=require("runtime/component-3d").Component3D;require("runtime/dependencies/webgl-debug"),exports.View=Component.specialize({STOP:{value:0,writable:!0},PLAY:{value:1,writable:!0},PAUSE:{value:2,writable:!0},_internalViewPoint:{value:null,writable:!0},_firstFrameDidRender:{value:!1,writable:!0},_sceneResourcesLoaded:{value:!1,writable:!0},_scene:{value:null,writable:!0},_consideringPointerForPicking:{writable:!0,value:!1},_mousePosition:{writable:!0,value:null},_showGradient:{value:!1,writable:!0},_showReflection:{value:!1,writable:!0},_showBBOX:{value:!1,writable:!0},_width:{value:null,writable:!0},_height:{value:null,writable:!0},_lastTime:{value:0,writable:!0},_state:{value:0,writable:!0},_viewPoint:{value:null,writable:!0},_sceneRenderer:{value:null,writable:!0},_disableRendering:{value:!1,writable:!0},_contextAttributes:{value:null,writable:!0},_shouldForceClear:{value:!0,writable:!0},_viewPointIndex:{value:0,writable:!0},_cameraController:{value:null,writable:!0},_defaultViewPoint:{value:null,writable:!0},translateComposer:{value:null,writable:!0},scaleFactor:{value:window.devicePixelRatio||1,writable:!0},selectedNode:{value:null,writable:!0},cameraController:{get:function(){return null==this._cameraController&&(this._cameraController=Montage.create(CameraController)),this._cameraController}},sceneWillChange:{value:function(){this.getResourceManager()&&this.getResourceManager().reset(),this._firstFrameDidRender=!1,this.delegate&&this.delegate.sceneWillChange&&this.delegate.sceneWillChange(),this._scene&&(this._scene.removeEventListener("cursorUpdate",this),this._scene.removeEventListener("materialUpdate",this),this._scene.removeEventListener("textureUpdate",this))}},sceneDidChange:{value:function(){this._scene&&(this._sceneResourcesLoaded=!1,this._scene.addEventListener("cursorUpdate",this),this._scene.addEventListener("textureUpdate",this),this._scene.addEventListener("materialUpdate",this),this.applyScene(),this.delegate&&this.delegate.sceneDidChange&&this.delegate.sceneDidChange())}},resourceAvailable:{value:function(){if(0==this.allowsProgressiveSceneLoading){var e=this.getResourceManager();e&&0==e.hasPendingRequests()&&(this.needsDraw=!0)}}},handleTextureUpdate:{value:function(e){var t=this.getResourceManager();if(t&&this.sceneRenderer&&this.sceneRenderer.webGLRenderer){var i=this.sceneRenderer.webGLRenderer.webGLContext,n=t.getResource(e.detail.value,this.sceneRenderer.webGLRenderer.textureDelegate,i);n&&this.resourceAvailable()}}},handleMaterialUpdate:{value:function(){this.needsDraw=!0}},handleCursorUpdate:{value:function(e){null!=this.element&&(this.element.style.cursor=e.detail)}},allowsProgressiveSceneLoading:{value:!1,writable:!0},scene:{get:function(){return this._scene},set:function(e){if(e){if(e.isLoaded()===!1)return e.addOwnPropertyChangeListener("status",this),void 0;this.needsDraw=!0}this.scene!=e&&(this.sceneWillChange(e),this._scene=e,this.sceneDidChange())}},constructor:{value:function(){this.super()}},play:{value:function(){switch(this._state){case this.PAUSE:case this.STOP:this._lastTime=Date.now(),this._state=this.PLAY,this.needsDraw=!0;break;default:}this._state=this.PLAY}},pause:{value:function(){this._state=this.PAUSE}},loops:{value:!0,writable:!0},stop:{value:function(){var e=this.getAnimationManager();e&&(e.sceneTime=0),this._state=this.STOP,this.needsDraw=!0}},animationDidStart:{value:function(){this.needsDraw=!0,this.element.style.cursor="default"}},animationDidStop:{value:function(){}},__viewPointAnimationStep:{value:0,writable:!0},animationDidUpdate:{value:function(e){var t=this._viewPointAnimationStep,i=e.extras.previousViewPoint;null==this.__matrix&&(this.__matrix=mat4.create()),null==this.__transform&&(this.__transform=Object.create(Transform).init());var n=i.glTFElement.transform,r=this.viewPoint.glTFElement.transform;n.interpolateToTransform(r,t,this.__transform),mat4.multiply(this.viewPoint.glTFElement.parent.worldMatrix,this.__transform.matrix,this.__matrix),this._internalViewPoint.transform.matrix=this.__matrix}},viewPointWillChange:{value:function(e,t){if(this.sceneRenderer&&t&&this.scene.glTFElement){var i=this.getAnimationManager(),n=0==i.nodeHasAnimatedAncestor(t.glTFElement);if(0==n&&null!=e&&(n|=0==i.nodeHasAnimatedAncestor(e.glTFElement)),n&&null!=e){var r=Object.create(BasicAnimation).init();r.path="_viewPointAnimationStep",r.target=this,r.delegate=this,r.from=Number(0),r.to=Number(1),r.duration=1e3,r.timingFunction="ease-out",r.extras.previousViewPoint=e,i.playAnimation(r),r.animationWasAddedToTarget()}}}},viewPointDidChange:{value:function(){this.cameraController.viewPoint=this.viewPoint,this.sceneRenderer&&this._viewPoint&&this.scene&&this.scene.glTFElement&&(this.sceneRenderer.technique.rootPass.viewPoint=this._internalViewPoint,this._viewPointIndex=this._getViewPointIndex(this.viewPoint),this.needsDraw=!0)}},allowsViewPointControl:{value:!0,writable:!0},viewPoint:{get:function(){return this._viewPoint},set:function(e){var t=this._viewPoint?this._viewPoint.id:null,i=e?e.id:null;if(t!=i){var n=null;this._viewPoint&&e&&this._viewPoint.scene==e.scene&&(n=this._viewPoint),this.viewPointWillChange(n,e),this._viewPoint=e;var r=this.getAnimationManager();r&&(r.sceneTime=0),e&&this.scene&&null==this._viewPoint.scene&&(this._viewPoint.scene=this.scene),this.viewPointDidChange()}}},canvas:{get:function(){return this.templateObjects?this.templateObjects.canvas:null}},sceneRenderer:{get:function(){return this._sceneRenderer},set:function(e){e!=this._sceneRenderer&&(this._sceneRenderer=e)}},handleStatusChange:{value:function(e,t,i){"loaded"===e&&(this.scene=i,this.needsDraw=!0)}},_getViewPointIndex:{value:function(e){for(var t=SceneHelper.getGLTFViewPoints(e.scene),i=0;t.length>i;i++)if(t[i].baseId===e.id)return i;return 0}},applyScene:{value:function(){var e=this.scene,t=e.glTFElement,i=this;if(this.sceneRenderer&&this.sceneRenderer.technique.rootPass){if(t){var n=SceneHelper.getViewPoints(e),r=n.length>0;if(r){var a=!1;this.viewPoint&&this.viewPoint.scene&&(a=this.viewPoint.scene===this.scene),a===!1&&(this.viewPoint=n[0])}else{var s=t.rootNode.getBoundingBox(!0);Object.create(BBox).init(s[0],s[1]),t.rootNode.transform._updateDirtyFlag(!1);var o=this.scene.glTFElement,s=o.rootNode.getBoundingBox(!0),l=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2,(s[0][2]+s[1][2])/2];l[2];var u=[l[0],l[1],l[2]];u[2]+=s[1][0]-s[0][0]+(s[1][2]-s[0][2]),this._defaultViewPoint=SceneHelper.createNodeIncludingCamera("camera01",e),this._defaultViewPoint.glTFElement.cameras[0].projection.zfar=u[2]+s[1][2]-s[0][2],this._defaultViewPoint.glTFElement.transform.translation=u,this.viewPoint=this._defaultViewPoint}this.sceneRenderer.scene=t}if(this.viewPoint&&(null==this.viewPoint.scene&&(this.viewPoint.scene=e),this.sceneRenderer&&this.viewPointDidChange()),this.allowsProgressiveSceneLoading===!1){var h=this.scene.prepareToRender(this.sceneRenderer.webGLRenderer);h.then(function(){i._sceneResourcesLoaded=!0,i.needsDraw=!0},function(){},function(){})}else this.needsDraw=!0}}},getRelativePositionToCanvas:{value:function(e){return dom.convertPointFromPageToNode(this.canvas,Point.create().init(e.pageX,e.pageY))}},enterDocument:{value:function(){var e=this;this.scene&&(this.scene.dispatchEventNamed("enteredDocument",!0,!1,this),this.scene.loadCSSStyles()),this.element.addEventListener("wheel",function(t){1==e.allowsViewPointControl&&null!=e.scene&&e.scene.rootNode&&(e.cameraController.node=e.scene.rootNode,e.cameraController.zoom(t)),t.stopPropagation(),t.preventDefault()},!1),this.element.addEventListener("gesturestart",function(e){e.preventDefault()},!1),this.element.addEventListener("gesturechange",function(e){e.preventDefault()},!1);var t=this.translateComposer;t.addEventListener("translate",function(t){1==e.allowsViewPointControl&&null!=e.scene&&e.scene.rootNode&&(e.cameraController.node=e.scene.rootNode,e.cameraController.translate(t)),e.needsDraw=!0}),t.addEventListener("translateStart",function(t){1==e.allowsViewPointControl&&null!=e.scene&&e.scene.rootNode&&(e.cameraController.node=e.scene.rootNode,e.cameraController.beginTranslate(t))},!1),t.addEventListener("translateEnd",function(t){1==e.allowsViewPointControl&&null!=e.scene&&e.scene.rootNode&&(e.cameraController.node=e.scene.rootNode,e.cameraController.endTranslate(t))},!1),this.addComposerForElement(t,this.canvas);var i;i=window.onwheel!==void 0?"wheel":"mousewheel",this.canvas.removeEventListener(i,t,!0),this.canvas.removeEventListener(i,t,!1);var n=!1;n&&(this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas));var r={premultipliedAlpha:!0,antialias:!0,preserveDrawingBuffer:!1},a=this.canvas.getContext("experimental-webgl",r)||this.canvas.getContext("webgl",r);if(null==a)return console.log("Please check that your browser enables & supports WebGL"),void 0;this._contextAttributes=a.getContextAttributes();var s=!1;if(this._contextAttributes&&(s=this._contextAttributes.antialias),0==s&&console.log("WARNING: anti-aliasing is not supported/enabled"),navigator){var o=null!=navigator.userAgent.match(/iPad/i);if(0==o){var l=navigator.userAgent;o=/iPad/i.test(l)||/iPhone OS 3_1_2/i.test(l)||/iPhone OS 3_2_2/i.test(l)}o&&(this._shouldForceClear=!0)}var u=Object.create(WebGLRenderer).initWithWebGLContext(a);a.enable(a.DEPTH_TEST);var h=null;this.sceneRenderer=Object.create(SceneRenderer),this.sceneRenderer.init(u,h);var c=this.getResourceManager();c.isObserving()||(c.observers.push(this),c.startObserving()),this.scene&&this.applyScene(),this.canvas.addEventListener("webglcontextlost",function(t){console.log("context was lost"),t.preventDefault(),e.getResourceManager.stopObserving(),e.sceneRenderer.webGLRenderer.resourceManager.reset(),e.needsDraw=!1,e._disableRendering=!0},!1),this.canvas.addEventListener("webglcontextrestored",function(t){console.log("context was restored"),t.preventDefault(),a.enable(a.DEPTH_TEST),e.needsDraw=!0,e._disableRendering=!1},!1),n&&setTimeout(function(){e.canvas.loseContext()},5e3);var e=this,d=BuiltInAssets.assetWithName("gradient");d.then(function(t){var i=Montage.create(Scene).init(t);e.gradientRenderer=Object.create(SceneRenderer),e.gradientRenderer.init(u,null),e.gradientRenderer.scene=i.glTFElement;var n=SceneHelper.getViewPoints(i);n&&n.length&&(e.gradientRenderer.technique.rootPass.viewPoint=n[0].glTFElement),e.needsDraw=!0},function(){},function(){}),this.needsDraw=!0,this.canvas.addEventListener("touchstart",this.start.bind(this),!0),this.canvas.addEventListener("touchend",this.end.bind(this),!0),this.canvas.addEventListener("touchcancel",this.end.bind(this),!0),this.canvas.addEventListener("touchmove",this.move.bind(this),!0),this.canvas.addEventListener("gesturechange",this,!0),this.canvas.addEventListener("mousedown",this.start.bind(this),!0),this.canvas.addEventListener("mouseup",this.end.bind(this),!0),this.canvas.addEventListener("mousemove",this.move.bind(this),!0),this.canvas.addEventListener("wheel",this,!0)}},captureMousewheel:{value:function(){this.needsDraw=!0}},captureWheel:{value:function(){this.needsDraw=!0}},captureGesturechange:{value:function(){this.needsDraw=!0}},_TOUCH_DOWN:{value:0},_TOUCH_UP:{value:1},_TOUCH_MOVE:{value:2},_eventType:{value:-1,writable:!0},_previousEventType:{value:-1,writable:!0},_lastHandledComponent:{value:null,writable:!0},_previousHandledComponent:{value:null,writable:!0},handleSelectedNode:{value:function(e){this._eventType===this._TOUCH_UP&&(null!=this._previousHandledComponent&&this._previousHandledComponent.handleEventNamed(Component3D._TOUCH_UP),this._eventType=-1);var t=null;if(null!=e){var i=this.scene.glTFElement.ids[e];null!=i&&null!=i.component3D&&(t=i.component3D)}this._previousEventType===this._TOUCH_MOVE&&t!==this._previousHandledComponent&&null!=this._previousHandledComponent&&this._previousHandledComponent.handleEventNamed(Component3D._EXIT),this._eventType===this._TOUCH_MOVE&&t!==this._previousHandledComponent?null!=t?t.handleEventNamed(Component3D._ENTER):this._eventType=-1:this._eventType===this._TOUCH_DOWN&&null!=t&&(t.handleEventNamed(Component3D._TOUCH_DOWN),this._eventType=-1),this._previousHandledComponent=t,this._previousEventType=this._eventType}},move:{value:function(e){var t=this.getRelativePositionToCanvas(e);this._mousePosition=[t.x*this.scaleFactor,this.height-t.y*this.scaleFactor],this._eventType=this._TOUCH_MOVE,this.needsDraw=!0}},start:{value:function(e){e.preventDefault(),this._consideringPointerForPicking=!0;var t=this.getRelativePositionToCanvas(e);this._mousePosition=[t.x*this.scaleFactor,this.height-t.y*this.scaleFactor],this._state===this.PLAY&&this.pause(),this._eventType=this._TOUCH_DOWN,this.needsDraw=!0}},end:{value:function(e){if(this._consideringPointerForPicking&&e.target===this.canvas&&e.preventDefault(),this._state===this.PAUSE&&this.scene&&this.viewPoint&&this.scene.glTFElement){var t=this.getAnimationManager();t.nodeHasAnimatedAncestor(this.viewPoint.glTFElement)&&this.play()}this._consideringPointerForPicking=!1,this._eventType=this._TOUCH_UP,this.handleSelectedNode(null),this._mousePosition=null}},getWebGLRenderer:{value:function(){return this.sceneRenderer?this.sceneRenderer.webGLRenderer:null}},getWebGLContext:{value:function(){var e=this.getWebGLRenderer();return e?e.webGLContext:null}},getResourceManager:{value:function(){var e=this.getWebGLRenderer();return e?e.resourceManager:null}},getAnimationManager:{value:function(){return this.scene&&this.scene.glTFElement?this.scene.glTFElement.animationManager:null}},showBBOX:{get:function(){return this._showBBOX},set:function(e){e!=this._showBBOX&&(this._showBBOX=e,this.needsDraw=!0)}},showGradient:{get:function(){return this._showGradient},set:function(e){e!=this._showGradient&&(this._showGradient=e,this.needsDraw=!0)}},showReflection:{get:function(){return this._showReflection},set:function(e){this._showReflection=e,this.needsDraw=!0}},displayAllBBOX:{value:function(e){if(this.scene&&this.scene.glTFElement){var t=mat4.identity(),i=this.scene.glTFElement.rootNode,n=this;i.apply(function(t,i,r){var a=mat4.create();if(mat4.multiply(r,t.transform.matrix,a),t.boundingBox){var s=n.viewPoint,o=s.glTFElement.cameras[0].projection.matrix;n.getWebGLRenderer().drawBBOX(t.boundingBox,e,a,o)}return a},!0,t)}}},width:{get:function(){if(null==this._width){var e=window.getComputedStyle(this.element,null);return parseInt(e.width)*this.scaleFactor}return this._width},set:function(e){e!=this._width&&(this._width=e*this.scaleFactor,this.needsDraw=!0)}},height:{get:function(){if(null==this._height){var e=window.getComputedStyle(this.element,null);return parseInt(e.height)*this.scaleFactor}return this._height},set:function(e){e!=this._height&&(this._height=e*this.scaleFactor,this.needsDraw=!0)}},_forwardToNextAnimatedViewPointIfNeeded:{value:function(){var e=this.getAnimationManager();if(e){if(1==e.nodeHasAnimatedAncestor(this.viewPoint.glTFElement))return;var t=this._viewPointIndex,i=SceneHelper.getViewPoints(this.scene);if(i.length>1){for(var n=this.viewPoint,r=0;i.length>r&&0==e.nodeHasAnimatedAncestor(n.glTFElement);)t=++t%i.length,n=i[t],r++;this.viewPoint=n}}}},draw:{value:function(){var e=this.getWebGLContext();if(!(null==e||this._disableRendering||(this.sceneRenderer.technique.rootPass.viewPoint=this._internalViewPoint,(this._shouldForceClear||null==this._contextAttributes.preserveDrawingBuffer||1==this._contextAttributes.preserveDrawingBuffer)&&(e.clearColor(0,0,0,0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT)),this.allowsProgressiveSceneLoading===!1&&this._sceneResourcesLoaded===!1||null==this._scene||null==this.viewPoint||this._disableRendering))){var t=this.width,i=this.height;(t!=this.canvas.width||i!=this.canvas.height)&&(this.canvas.style.width=t/this.scaleFactor+"px",this.canvas.style.height=i/this.scaleFactor+"px",this.canvas.width=t,this.canvas.height=i,e.viewport(0,0,t,i));var n=this.viewPoint,r=Date.now();if(this.sceneRenderer&&this.scene){var a=this.getAnimationManager();if(this._state==this.PLAY&&a){this._forwardToNextAnimatedViewPointIfNeeded(),a.sceneTime+=r-this._lastTime;var s=this.scene.glTFElement.endTime;a.sceneTime/1e3>s&&(this.loops?a.sceneTime=0==s?0:a.sceneTime%s:this.stop()),a.updateTargetsAtTime(a.sceneTime,this.getResourceManager())}n.glTFElement&&(n.glTFElement.cameras[0].projection.aspectRatio=t/i,this._internalViewPoint.transform.matrix=n.glTFElement.worldMatrix,this._internalViewPoint.cameras[0]=n.glTFElement.cameras[0]),a.evaluateAtTime(r,this.getResourceManager()),a.hasActiveAnimations()&&(this.needsDraw=!0)}if(this._lastTime=r,this._state==this.PLAY&&(this.needsDraw=!0),this.scene&&(this.sceneRenderer.webGLRenderer,e)){null==this.__renderOptions&&(this.__renderOptions={});var o=this.showReflection;if(o){e.depthFunc(e.LESS),e.enable(e.DEPTH_TEST),e.frontFace(e.CW),e.depthMask(!0);var l=this.scene.glTFElement.rootNode,u=l.getBoundingBox(!0),h=mat4.create(l.transform.matrix),c=mat4.scale(mat4.identity(),[1,1,-1]);mat4.multiply(c,l.transform.matrix),l.transform.matrix=c;var d=l.getBoundingBox(!0),m=mat4.identity(),p=mat4.translate(mat4.identity(),[0,0,u[0][2]-d[1][2]]);mat4.multiply(m,p),mat4.multiply(m,c),l.transform.matrix=m,this.sceneRenderer.render(r,this.__renderOptions),l.transform.matrix=h,e.frontFace(e.CCW)}(this.showGradient||o)&&this.viewPoint===this._defaultViewPoint&&this.gradientRenderer&&(e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.disable(e.CULL_FACE),e.depthMask(!1),this.gradientRenderer.render(r,this.__renderOptions),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.disable(e.BLEND)),this._mousePosition&&(this.__renderOptions.picking=!0,this.__renderOptions.coords=this._mousePosition,this.__renderOptions.delegate=this,this.sceneRenderer.render(r,this.__renderOptions)),this.__renderOptions.picking=!1,this.__renderOptions.coords=null,this.__renderOptions.delegate=null,this.sceneRenderer.render(r,this.__renderOptions),this.showBBOX&&this.displayAllBBOX(this.sceneRenderer.technique.rootPass.scenePassRenderer._viewPointMatrix),e.flush(),this._firstFrameDidRender===!1&&(this._firstFrameDidRender=!0,this.dispatchEventNamed("firstFrameDidRender",!0,!1,this))}}}},willDraw:{value:function(){}},templateDidLoad:{value:function(){window.addEventListener("resize",this,!0),this.parentComponent;var e=TranslateComposer.create();e.animateMomentum=!0,e.hasMomentum=!0,e.allowFloats=!0,e.pointerSpeedMultiplier=.15,this._internalViewPoint=SceneHelper.createGLTFNodeIncludingCamera("__internal_viewPoint__"),this.translateComposer=e}}});