montageDefine("d41c331","core/serialization/serialization",{dependencies:["../core","./serializer/montage-labeler","./deserializer/montage-reviver","frb/parse","frb/stringify"],factory:function(e,t){var n=e("../core").Montage,i=e("./serializer/montage-labeler").MontageLabeler,r=e("./deserializer/montage-reviver").MontageReviver,a=e("frb/parse"),s=e("frb/stringify"),o=n.specialize({_serializationString:{value:null},_serializationObject:{value:null},_serializationLabels:{value:null},initWithString:{value:function(e){return this._serializationString=e,this._serializationObject=null,this._serializationLabels=null,this}},initWithObject:{value:function(e){return this._serializationString=null,this._serializationObject=e,this._serializationLabels=null,this}},clone:{value:function(){var e=new o;return e.initWithString(this.getSerializationString()),e}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var e;return this._serializationLabels||(e=this.getSerializationObject())&&(this._serializationLabels=Object.keys(e)),this._serializationLabels}},getExternalObjectLabels:{value:function(){var e=this.getSerializationObject(),t=[];for(var n in e)0===Object.keys(e[n]).length&&t.push(n);return t}},hasSerializationLabel:{value:function(e){return e in this.getSerializationObject()}},isExternalObject:{value:function(e){var t=this.getSerializationObject();return t&&e in t?0===Object.keys(t[e]).length:!1}},isAlias:{value:function(e){var t=this.getSerializationObject();return t&&e in t?"alias"in t[e]:!1}},getElementId:{value:function(e){var t=this.getSerializationObject(),i=n.getPath.call(t,e+".properties.element");return i?i["#"]:void 0}},getSerializationLabelsWithElements:{value:function(e){var t=new c,n=[];return t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&e.indexOf(t.data)>=0&&(t=t.parent,t&&"properties"===t.name&&(t=t.parent,t&&"montageObject"===t.type&&n.push(t.label)))}),n}},renameElementReferences:{value:function(e){var t=new c;t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&t.data in e&&(t.data=e[t.data])})}},renameSerializationLabels:{value:function(e){var t=new c;t.initWithSerialization(this),t.visitSerialization(function(t){if(t.label){var n=t.label;n in e&&(t.label=e[n])}if("reference"===t.type){var i=t.data;i in e&&(t.data=e[i])}})}},mergeSerialization:{value:function(e,t){return l.mergeSerializations(this,e,t)}},extractSerialization:{value:function(e,t){var n=new u;return n.initWithSerialization(this),n.extractSerialization(e,t)}}}),l=n.specialize(null,{mergeSerializations:{value:function(e,t,n){var i,r,a,s,o,l,c={};a=e.getSerializationLabels(),s=t.getSerializationLabels(),o=this._createCollisionTable(a,s,c,n&&n.labeler),n&&n.willMergeObjectWithLabel&&(l=this._willMergeObjectWithLabel(n,e,t,c),o=o||l),o&&(t=t.clone(),t.renameSerializationLabels(c),s=t.getSerializationLabels()),i=e.getSerializationObject(),r=t.getSerializationObject();for(var u,h=0;u=s[h];h++)-1===a.indexOf(u)&&(i[u]=r[u]);return e.initWithObject(i),c}},_willMergeObjectWithLabel:{value:function(e,t,n,i){var r,a,s,o,l,c=!1,u=n.getSerializationLabels();i&&(s=[],Object.keys(i).forEach(function(e){s.push(i[e])}));for(var h,d=0;h=u[d];d++)if(a=i&&i[h],r=e.willMergeObjectWithLabel(h,a),"string"==typeof r){if(o=this._isLabelValidInSerialization(r,t),o||(l=!this._isLabelValidInSerialization(r,n)&&-1===s.indexOf(r)),!o&&!l)throw Error("willMergeObjectWithLabel either needs to return a label that exists in the destination serialization to indicate it's the same object or return a completely new label to rename the object being merged. \""+r+'"  destination: '+t.getSerializationString()+"\n source: "+n.getSerializationString()+"\n collision table: "+JSON.stringify(i,null,4));c=!0,i[h]=r}return c}},_isLabelValidInSerialization:{value:function(e,t){var n,i;return t.hasSerializationLabel(e)?!0:(i=e.indexOf(":"),i>0&&(n=e.slice(0,i),t.hasSerializationLabel(n))?!0:!1)}},_createCollisionTable:{value:function(e,t,n,r){for(var a,s,o,l,r=r||new i,c=!1,u=Object.create(null),h=0;e.length>h;h++)o=e[h],l=o.indexOf(":"),l>0&&(a=o.slice(0,l),r.addLabel(a),u[a]=1),r.addLabel(o),u[o]=1;for(var h=0;o=t[h];h++)l=o.indexOf(":"),l>0?(a=o.slice(0,l),s=n[a],s?(n[o]=s+":"+o.slice(l+1),c=!0):a in u?(s=r.generateLabel(r.getLabelBaseName(a)),t.indexOf(a)>=0&&(n[a]=s),n[o]=s+o.slice(l),c=!0):r.addLabel(a)):o in u&&!(o in n)?(n[o]=r.generateLabel(r.getLabelBaseName(o)),c=!0):r.addLabel(o);return c}}}),c=n.specialize({initWithSerialization:{value:function(e){this._serialization=e}},visitSerialization:{value:function(e){var t=this._serialization.getSerializationObject();this._walkRootObjects(e,t),this._serialization.initWithObject(t)}},visitSerializationObject:{value:function(e,t){var n=this._serialization.getSerializationObject();if(!(e in n))throw Error('Object "'+e+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(t,n,e),this._serialization.initWithObject(n)}},changeLabel:{value:function(e,t){var n,i=this._serialization.getSerializationObject();n=i[e],delete i[e],i[t]=n}},_walkRootObjects:{value:function(e,t){for(var n in t)this._walkRootObject(e,t,n)}},_walkRootObject:{value:function(e,t,n){var i=t[n];"value"in i?this._walkObject(e,i,"value",n):this._walkCustomObject(e,t,n)}},_walkObject:{value:function(e,t,n,i,a){var s,o=t[n],l=r.getTypeOf(o);if(s={type:l},i?s.label=i:s.name=n,a&&(s.parent=a),"number"===l||"string"===l||"null"===l)s.data=o,e(s),t[n]=s.data;else if("regexp"===l)s.data=o["/"],e(s),o["/"]=s.data;else if("reference"===l)s.data=o["@"],e(s),o["@"]=s.data;else if("Element"===l)s.data=o["#"],e(s),o["#"]=s.data;else if("array"===l){s.data=o,e(s),t[n]=o=s.data;for(var c=0,u=o.length;u>c;c++)this._walkObject(e,o,""+c,null,s)}else if("object"===l){s.data=o,e(s),t[n]=o=s.data;for(var n in o)this._walkObject(e,o,n,null,s)}s.label!=i&&this.changeLabel(i,s.label)}},_walkCustomObject:{value:function(e,t,n){var i,r=t[n];i={type:"montageObject",label:n,data:r},e(i),t[n]=r=i.data,i.label!=n&&this.changeLabel(n,i.label),r.properties&&this._walkObject(e,r,"properties",null,i),r.listeners&&this._walkObject(e,r,"listeners",null,i),r.bindings&&this._walkBindings(e,r,null,i),r.localizations&&this._walkLocalizations(e,r,null,i)}},_walkBindings:{value:function(e,t,n){var i,r=t.bindings;i={type:"bindings",data:r,parent:n},e(i),t.bindings=r=i.data;for(var a in r)this._walkBinding(e,r,a,i)}},_walkBinding:{value:function(e,t,n,i){var r,a=t[n];r={type:"binding",name:n,data:a,parent:i},e(r),t[n]=a=r.data,this._walkBindingData(e,a,r)}},_walkBindingData:{value:function(e,t,n){var i,r,o=!1;i=t["<-"]||t["<->"],r=Object.clone(a(i)),this._walksBindingReferences(r,function(t){var n={type:"reference",data:t.label};e(n),t.label!==n.data&&(t.label=n.data,o=!0)}),o&&("<-"in t?t["<-"]=s(r):t["<->"]=s(r)),t.converter&&this._walkObject(e,t,"converter",null,n)}},_walkLocalizations:{value:function(e,t,n){var i,r=t.localizations;i={type:"localizations",data:r,parent:n},e(i),t.localizations=r=i.data;for(var a in r)this._walkLocalization(e,r,a,i)}},_walkLocalization:{value:function(e,t,n,i){var r,a,s=t[n];if(r={type:"localization",name:n,data:s,parent:i},e(r),t[n]=s=r.data,"object"==typeof s.key&&this._walkBindingData(e,s.key,r),"object"==typeof s.default&&this._walkBindingData(e,s.default,r),"object"==typeof s.data){a=s.data;for(var n in a)this._walkBindingData(e,a[n],r)}}},_walksBindingReferences:{value:function(e,t){var n=e.args;if("component"===e.type&&t(e),n)for(var i=0,r=n.length;r>i;i++)this._walksBindingReferences(n[i],t)}}}),u=n.specialize({_serialization:{value:null},initWithSerialization:{value:function(e){this._serialization=e}},extractSerialization:{value:function(e,t){var n,i=new c,r={},a=[];n=this._serialization.getSerializationObject(),i.initWithSerialization(this._serialization);for(var s,l=0;s=e[l];l++)r[s]=n[s],i.visitSerializationObject(s,function(t){var n;"reference"===t.type&&(n=t.data,-1===a.indexOf(n)&&-1===e.indexOf(n)&&a.push(n))});if(t)for(var s,l=0;s=t[l];l++)s in n&&!(s in r)&&(r[s]={});for(var s,l=0;s=a[l];l++)r[s]={};return(new o).initWithObject(r)}}});t.Serialization=o,t.SerializationMerger=l,t.SerializationInspector=c,t.SerializationExtractor=u}});