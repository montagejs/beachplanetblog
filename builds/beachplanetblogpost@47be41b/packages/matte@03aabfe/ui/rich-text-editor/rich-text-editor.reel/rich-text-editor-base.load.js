montageDefine("03aabfe","ui/rich-text-editor/rich-text-editor.reel/rich-text-editor-base",{dependencies:["montage/ui/component","./rich-text-sanitizer","../overlays/rich-text-linkpopup.reel","../overlays/rich-text-resizer.reel","montage/core/promise","montage/core/undo-manager"],factory:function(e,t){var i=e("montage/ui/component").Component,n=e("./rich-text-sanitizer").Sanitizer,a=e("../overlays/rich-text-linkpopup.reel").RichTextLinkPopup,s=e("../overlays/rich-text-resizer.reel").RichTextResizer,o=e("montage/core/promise").Promise,r=e("montage/core/undo-manager").defaultUndoManager;t.RichTextEditorBase=i.specialize({_COMMANDS:{enumerable:!1,value:null},COMMANDS:{enumerable:!1,get:function(){return this._COMMANDS||(this._COMMANDS=[{property:"bold"},{property:"underline"},{property:"italic"},{property:"strikeThrough"},{property:"baselineShift",method:this._baselineShiftGetState},{property:"justify",method:this._justifyGetState},{property:"listStyle",method:this._listStyleGetState},{property:"fontName",method:this._fontNameGetState},{property:"fontSize"},{property:"backColor"},{property:"foreColor"}]),this._COMMANDS}},_overlays:{enumerable:!1,value:void 0},_overlaySlot:{enumerable:!1,value:null},_activeOverlay:{enumerable:!1,value:null},_innerElement:{enumerable:!1,value:null},_originalDomContent:{value:null},_undoManager:{enumerable:!1,value:void 0},_isTyping:{enumerable:!1,value:!1},_startTyping:{enumerable:!1,value:function(){return this._doingUndoRedo?(this._isTyping=!1,void 0):(this._isTyping||(this._isTyping=!0,this.undoManager&&this.undoManager.register("Typing",o.resolve([this._undo,this,"Typing",this._innerElement]))),void 0)}},_stopTyping:{enumerable:!1,value:function(){this._isTyping&&(this._isTyping=!1)}},_hasSelectionChangeEvent:{enumerable:!1,value:null},_uniqueId:{enumerable:!1,value:Math.floor(1e3*Math.random())+"-"+Math.floor(1e3*Math.random())},_contentInitialized:{enumerable:!1,value:!1},_needsAssignOriginalContent:{enumerable:!1,value:!0},_needsAssingValue:{enumerable:!1,value:!1},_setCaretAtEndOfContent:{enumerable:!1,value:!1},_selectionChangeTimer:{enumerable:!1,value:null},_hasFocus:{enumerable:!1,value:!1},_needsFocus:{value:!1},_isActiveElement:{enumerable:!1,value:!1},_readOnly:{enumerable:!1,value:!1},_value:{enumerable:!1,value:""},_textValue:{enumerable:!1,value:""},delegate:{enumerable:!0,value:null},_sanitizer:{enumerable:!1,value:void 0},_allowDrop:{enumerable:!1,value:!0},_getState:{value:function(e,t){var i,n=document.activeElement,a=this._innerElement;return a&&!this["_"+e+"_locked"]?(a&&a!=n&&a.focus(),i=document.queryCommandValue(t),"true"==i&&(i=!0),"false"==i&&(i=!1),a&&a!=n&&n.focus(),i):this["_"+e]}},_genericCommandGetter:{value:function(e,t){var i="_"+e;return this[i]=this._getState(e,t),this[i]}},_genericCommandSetter:{value:function(e,t,i){var n=this._getState(e,t);n!==i&&this.doAction(t,"boolean"==typeof i?!1:i)}},_bold:{value:!1},_underline:{value:!1},_italic:{value:!1},_strikeThrough:{value:!1},_baselineShiftGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._baselineShift_locked?(t!=e&&t.focus(),this._getState("baselineShift","subscript")?"subscript":this._getState("baselineShift","superscript")?"superscript":"baseline"):this._baselineShift}},_baselineShift:{value:"baseline"},_listStyleGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._listStyle_locked?(t!=e&&t.focus(),this._getState("listStyle","insertorderedlist")?"ordered":this._getState("listStyle","insertunorderedlist")?"unordered":"none"):this._listStyle}},_listStyle:{value:"none"},_justifyGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._justify_locked?(t!=e&&t.focus(),this._getState("justify","justifyleft")?"left":this._getState("justify","justifycenter")?"center":this._getState("justify","justifyright")?"right":this._getState("justify","justifyfull")?"full":"left"):this._justify}},_justify:{value:"left"},_fontNameGetState:{enumerable:!1,value:function(){var e=this._getState("fontName","fontname");return e&&(e=e.replace(/\"|\'/g,"")),e}},_fontName:{value:""},_fontSize:{value:0},_backColor:{value:""},_foreColor:{value:""},_updateStates:{enumerable:!0,value:function(){var e,t,i,n,a,s,o,r,l=this,u=this.COMMANDS,c=u.length;for(r=0;c>r;r++)e=u[r],"object"==typeof e&&(i=e.property,t=e.name||i.toLowerCase(),s=e.method||this._getState,o=this.getOwnPropertyChangeDescriptor(i),o&&(a=this["_"+i],n=s.call(this,i,t),n!==a&&(this["_"+i+"_locked"]=!0,this.dispatchBeforeOwnPropertyChange(i,a),this["_"+i]=n,this.dispatchOwnPropertyChange(i,n),l["_"+i+"_locked"]=!1)))}},enterDocument:{value:function(e){var t;e&&(t=this.element,t.classList.add("montage-Editor-container"),t.addEventListener("focus",this,!0),t.addEventListener("dragstart",this,!1),t.addEventListener("dragenter",this,!1),t.addEventListener("dragover",this,!1),t.addEventListener("drop",this,!1),t.addEventListener("dragend",this,!1),void 0===this._sanitizer&&(this._sanitizer=new n),void 0===this._undoManager&&(this._undoManager=r),void 0===this._overlays&&(this._overlays=[new s,new a]),this._callOverlays("initWithEditor",this,!0))}},draw:{enumerable:!1,value:function(){var e,t,i,n,a,s=this.element;if(this._needsAssingValue||this._needsAssignOriginalContent){if(e=this._innerElement=s.querySelector(".matte-Editor"),this._contentInitialized&&(s.replaceChild(e.cloneNode(!0),e),e=this._innerElement=s.querySelector(".matte-Editor")),e.setAttribute("contenteditable",this._readOnly?"false":"true"),e.classList.add("editor-"+this._uniqueId),e.innerHTML="",this._needsAssingValue)this._value&&!this._dirtyValue?e.innerHTML=this._value:this._textValue&&!this._dirtyTextValue&&(e.innerText?e.innerText=this._textValue:e.textContent=this._textValue);else if(this._needsAssignOriginalContent){if(t=this._originalDomContent,n=!1,t instanceof Element)e.appendChild(t),n=!0;else for(a=0;t&&(i=t[a]);a++)e.appendChild(i),n=!0;n&&(this._dirtyValue=!0,this._dirtyTextValue=!0)}this._adjustPadding(),this.markDirty(),this._needsAssingValue=!1,this._needsAssignOriginalContent=!1,this._contentInitialized=!0,this._setCaretAtEndOfContent=!0,this.hasFocus&&this.focus()}else e=this._innerElement;this._readOnly?(e.setAttribute("contentEditable","false"),s.classList.add("readonly")):(e.setAttribute("contentEditable","true"),s.classList.remove("readonly"))}},didDraw:{value:function(){if(this._needsFocus)if(this._innerElement.focus(),document.activeElement==this._innerElement)this._needsFocus=!1;else{var e=window.getComputedStyle(this.element);"hidden"==e.getPropertyValue("visibility")||"none"==e.getPropertyValue("display")?this._needsFocus=!1:this.needsDraw=!0}}},slotDidSwitchContent:{enumerable:!1,value:function(e,t,i,n,a){a&&"function"==typeof a.didBecomeInactive&&a.didBecomeInactive(),i&&"function"==typeof i.didBecomeActive&&i.didBecomeActive()}},_adjustPadding:{enumerable:!1,value:function(){var e=this._innerElement,t=0,i=0,n=function(e,a,s){var o,r=e?e.childNodes:[],l=r.length,u=e.offsetLeft,c=e.offsetTop;for(e.offsetParent&&(u+=a,c+=s),t>u&&(t=u),i>c&&(i=c),o=0;l>o;o++)n(r[o],u,c)};n(e,e.offsetLeft,e.offsetTop);var a=document.defaultView.getComputedStyle(e),s=a.paddingLeft,o=a.paddingTop;s=s.match(/%$/)?parseInt(s,10)*e.clientWidth:parseInt(s,10),o=o.match(/%$/)?parseInt(o,10)*e.clientHeight:parseInt(o,10),0>t&&(e.style.paddingLeft=-t-s+"px"),0>i&&(e.style.paddingTop=-i-o+"px")}},captureFocus:{enumerable:!1,value:function(){var e,t,i,n=this,a=this.element,s=this._innerElement;if(this.dispatchBeforeOwnPropertyChange("hasFocus",n._hasFocus),n._hasFocus=!0,this.dispatchOwnPropertyChange("hasFocus",n._hasFocus),e=s&&s===document.activeElement,e!=this._isActiveElement&&(this.dispatchBeforeOwnPropertyChange("isActiveElement",this._isActiveElement),n._isActiveElement=e,this.dispatchOwnPropertyChange("isActiveElement",this._isActiveElement)),this._setCaretAtEndOfContent){var o,r,l=this._lastInnerNode(),u=["#text","BR","IMG"];l&&(-1!==u.indexOf(l.nodeName)&&(l=l.parentNode),o=document.createRange(),r=l.childNodes?l.childNodes.length:0,o.setStart(l,r),o.setEnd(l,r),this._selectedRange=o),t=this._selectedRange,i=setInterval(function(){n._equalRange(n._selectedRange,t)&&s.scrollTop+s.offsetHeight!=s.scrollHeight&&(s.scrollTop=s.scrollHeight-s.offsetHeight)},10),setTimeout(function(){clearInterval(i)},1e3),this._setCaretAtEndOfContent=!1}if(a.addEventListener("blur",this,!0),a.addEventListener("input",this),a.addEventListener("keydown",this),a.addEventListener("keypress",this),a.addEventListener("cut",this),a.addEventListener("paste",this),a.addEventListener(window.Touch?"touchstart":"mousedown",this),document.addEventListener(window.Touch?"touchend":"mouseup",this),document.addEventListener("selectionchange",this,!1),null===this._hasSelectionChangeEvent){var n=this;setTimeout(function(){null===n._hasSelectionChangeEvent&&(n._hasSelectionChangeEvent=!1)},0)}this._hasSelectionChangeEvent===!1&&a.addEventListener("keydup",this),document.execCommand("enableObjectResizing",!1,!1),document.execCommand("styleWithCSS",!1,!0),this._updateStates()}},captureBlur:{enumerable:!1,value:function(){var e,t=this,i=this.element,n=this._innerElement;this.dispatchBeforeOwnPropertyChange("hasFocus",t._hasFocus),t._hasFocus=!1,this.dispatchOwnPropertyChange("hasFocus",t._hasFocus),e=n&&n===document.activeElement,e!=this._isActiveElement&&(this.dispatchBeforeOwnPropertyChange("isActiveElement",this._isActiveElement),t._isActiveElement=e,this.dispatchOwnPropertyChange("isActiveElement",this._isActiveElement)),this._selectionChangeTimer&&clearTimeout(this._selectionChangeTimer),i.removeEventListener("blur",this,!0),i.removeEventListener("input",this),i.removeEventListener("keydown",this),i.removeEventListener("keypress",this),i.removeEventListener("cut",this),i.removeEventListener("paste",this),i.removeEventListener(window.Touch?"touchstart":"mousedown",this),document.removeEventListener(window.Touch?"touchend":"mouseup",this),document.removeEventListener("selectionchange",this),this._hasSelectionChangeEvent===!1&&i.removeEventListener("keydup",this)}},handleKeydown:{enumerable:!1,value:function(e){-1!=["Left","Right","Up","Down","Home","End"].indexOf(e.keyIdentifier)&&this._stopTyping()}},handleKeypress:{enumerable:!1,value:function(){this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.markDirty()}},handleInput:{enumerable:!1,value:function(e){this._executingCommand||this._ignoreNextInputEvent||this._startTyping(),delete this._ignoreNextInputEvent,this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.handleDragend(e),this.markDirty()}},handleShortcut:{enumerable:!1,value:function(e,t){return this.doAction(t),!0}},handleMousedown:{enumerable:!1,value:function(e){this._savedSelection=this._selectedRange,this._callOverlays("mousedown"==e.type?"editorMouseDown":"editorTouchStart",e)}},handleMouseup:{enumerable:!1,value:function(e){this._equalRange(this._savedSelection,this._selectedRange)||this._stopTyping(),this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.handleDragend(e),this._callOverlays("mouseup"==e.type?"editorMouseUp":"editorTouchEnd",e)}},handleTouchstart:{enumerable:!1,value:function(){this.handleMousedown(event)}},handleTouchend:{enumerable:!1,value:function(){this.handleMouseup(event)}},handleSelectionchange:{enumerable:!1,value:function(){var e=this;null==this._hasSelectionChangeEvent&&(this._hasSelectionChangeEvent=!0),this._ignoreSelectionchange||this._equalRange(this._selectedRange,this._savedSelectedRange)||(this._savedSelectedRange=this._selectedRange,this._selectionChangeTimer&&clearTimeout(this._selectionChangeTimer),this._selectionChangeTimer=setTimeout(function(){e._updateStates(),e._dispatchEditorEvent("editorSelect")},100),this._callOverlays("editorSelectionDidChange",this._savedSelectedRange))}},handleDragstart:{enumerable:!1,value:function(e){var t=this._delegateMethod("canDrag");return t&&!t.call(this.delegate,this,e.srcElement)?(e.preventDefault(),e.stopPropagation(),void 0):(this._dragSourceElement=e.srcElement,void 0)}},handleDragenter:{enumerable:!1,value:function(e){this.hideOverlay();var t=this._delegateMethod("canDrop");this._allowDrop=t?t.call(this.delegate,this,e,this._dragSourceElement):!0,e.dataTransfer.dropEffect=this._allowDrop?"copy":"none"}},handleDragend:{enumerable:!1,value:function(){delete this._dragSourceElement,delete this._dragOverX,delete this._dragOverY,this.handleSelectionchange()}},handleDragover:{enumerable:!1,value:function(e){var t,i=this;this._dragSourceElement&&this._allowDrop||(e.dataTransfer.dropEffect=this._allowDrop?"copy":"none",e.preventDefault(),e.stopPropagation(),!this._allowDrop||e.x===this._dragOverX&&e.y===this._dragOverY||(this._dragOverX=e.x,this._dragOverY=e.y,this._ignoreSelectionchange=!0,document.caretRangeFromPoint?t=document.caretRangeFromPoint(e.x,e.y):e.rangeParent&&e.rangeOffset&&(t=document.createRange(),t.setStart(e.rangeParent,e.rangeOffset),t.setEnd(e.rangeParent,e.rangeOffset)),t&&(this._selectedRange=t),this._ignoreSelectionchangeTimer&&clearTimeout(this._ignoreSelectionchangeTimer),this._ignoreSelectionchangeTimer=setTimeout(function(){delete i._ignoreSelectionchange,i._ignoreSelectionchangeTimer=null},0)))}},handleDrop:{enumerable:!1,value:function(e){var t,i,n,a,s,r,l=this,u=e.dataTransfer.files,c=u.length;if(this._dragSourceElement)return this._stopTyping(),this.undoManager&&this.undoManager.register("Move",o.resolve([this._undo,this,"Move",this._innerElement])),this._ignoreNextInputEvent=!0,this.handleDragend(e),this.handleSelectionchange(),void 0;if(e.preventDefault(),e.stopPropagation(),c)for(a=0;c>a;a++)t=u[a],s=this._delegateMethod("shouldDropFile"),r=!0,window.FileReader?(n=new FileReader,n.onload=function(){i=n.result,s&&(r=s.call(l.delegate,l,t,i)),r===!0?t.type.match(/^image\//i)&&(l.execCommand("insertimage",!1,i,"Drop"),l.markDirty()):"string"==typeof r&&(l.execCommand("inserthtml",!1,r,"Drop"),l.markDirty())},n.onprogress=function(){},n.onerror=function(){},n.readAsDataURL(t)):(s&&(r=s.call(this.delegate,this,t)),"string"==typeof r&&(l.execCommand("inserthtml",!1,r,"Drop"),l.markDirty()));else{if(i=e.dataTransfer.getData("text/html"))this._sanitizer&&(i=this._sanitizer.willInsertHtmlData(i,this._uniqueId));else if(i=e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("text")){var h=document.createElement("div");h.innerText?h.innerText=i:h.textContent=i,i=h.innerHTML}if(i){var r,s=this._delegateMethod("shouldDrop");s?(r=s.call(this.delegate,this,e,i,"text/html"),i=r===!0?i.replace(/\<meta [^>]+>/gi,""):r===!1?null:r):i=i.replace(/\<meta [^>]+>/gi,""),i&&i.length&&(this.execCommand("inserthtml",!1,i,"Drop"),this.markDirty())}}this.handleDragend(e)}},handleCut:{enumerable:!1,value:function(){this._stopTyping(),this.undoManager&&this.undoManager.register("Cut",o.resolve([this._undo,this,"Cut",this._innerElement])),this._ignoreNextInputEvent=!0}},handlePaste:{enumerable:!1,value:function(e){var t,i,n,a,s,o,r,l=this,u=e.clipboardData,c=u.getData("text/html");a=c&&c.match(/^(<meta [^>]*>|<html>)/i),c&&a?this._sanitizer&&(c=this._sanitizer.willInsertHtmlData(c,this._uniqueId)):(c=u.getData("text/plain")||u.getData("text"),c&&(n=document.createElement("div"),n.innerText?n.innerText=c:n.textContent=c,c=n.innerHTML)),c?(t=this._delegateMethod("shouldPaste"),t?(i=t.call(this.delegate,this,e,c,"text/html"),c=i===!0?c.replace(/\<meta [^>]+>/gi,""):i===!1?null:i):c=c.replace(/\<meta [^>]+>/gi,""),c&&c.length&&(this.execCommand("inserthtml",!1,c,"Paste"),this.markDirty())):u.items.length&&(s=u.items[0],"file"==s.kind&&s.type.match(/^image\/.*$/)&&(o=s.getAsFile(),i=!0,t=l._delegateMethod("shouldPasteFile"),window.FileReader?(r=new FileReader,r.onload=function(){c=r.result,t&&(i=t.call(l.delegate,l,o,c)),i===!0&&o.type.match(/^image\//i)&&(l.execCommand("insertimage",!1,c,"Paste"),l.markDirty())},r.onprogress=function(){},r.onerror=function(){},r.readAsDataURL(o)):t&&(i=t.call(this.delegate,this,o)))),e.preventDefault(),e.stopPropagation()}},handleAction:{enumerable:!1,value:function(e){var t=e.currentTarget,i=t.action||t.identifier,n=!1;i&&this.doAction(i,n)}},doAction:{enumerable:!0,value:function(e,t){this.execCommand(e,!1,t),this._updateStates()}},_undo:{enumerable:!1,value:function(e,t){var i=this._innerElement;t&&t!==i||(this._doingUndoRedo=!0,this._ignoreNextInputEvent=!0,document.execCommand("undo",!1,null),this.markDirty(),this.undoManager&&this.undoManager.register(e,o.resolve([this._redo,this,e,i])),this._doingUndoRedo=!1)}},_redo:{enumerable:!1,value:function(e,t){var i=this._innerElement;t&&t!==i||(this._doingUndoRedo=!0,this._ignoreNextInputEvent=!0,document.execCommand("redo",!1,null),this.markDirty(),this.undoManager&&this.undoManager.register(e,o.resolve([this._undo,this,e,i])),this._doingUndoRedo=!1)}},_execCommandLabel:{enumerable:!1,value:{bold:"Bold",italic:"Italic",underline:"Underline",strikethrough:"strikeThrough",subscript:"Subscript",superscript:"Superscript",indent:"Indent",outdent:"Outdent",insertorderedlist:"Ordered List",insertunorderedlist:"Unordered List",justifyleft:"Left Align",justifycenter:"Center",justifyright:"Right Align",justifyfull:"Justify",fontname:"Set Font",fontsize:"Set Size",forecolor:"Set Color",backcolor:"Set Color"}},_dispatchEditorEvent:{enumerable:!1,value:function(e,t){var i=document.createEvent("CustomEvent");i.initCustomEvent(e,!0,!1,void 0===t?null:t),i.type=e,this.dispatchEvent(i)}},_delegateMethod:{enumerable:!1,value:function(e){var t,i,n;return i="string"==typeof this.identifier?this.identifier+e.toCapitalized():e,(t=this.delegate)&&"function"==typeof(n=t[i])?n:null}},_callOverlays:{value:function(e,t,i){var n,a,s=this._activeOverlay;if(s&&"function"==typeof s[e]&&s[e](t)&&!i)return!0;for(n in this._overlays)if(a=this._overlays[n],a!==s&&"function"==typeof a[e]&&a[e](t)&&!i)return!0;return!1}},_nodeOffset:{enumerable:!1,value:function(e){var t,i=e.parentNode,n=i.childNodes;for(t in n)if(n[t]===e)return parseInt(t,10);return-1}},_lastInnerNode:{enumerable:!1,value:function(){for(var e=this._innerElement.childNodes,t=e.length,i=null;e&&(t=e.length);)i=e[t-1],e=i.childNodes;return i}},_selectedRange:{enumerable:!1,set:function(e){if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else e.select()},get:function(){var e,t;if(window.getSelection?e=window.getSelection():document.selection&&(e=document.selection.createRange()),e.getRangeAt)return e.rangeCount?e.getRangeAt(0):document.createRange();var t=document.createRange();return t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),t}},_equalRange:{enumerable:!1,value:function(e,t){return e===t?!0:e&&t?e.startContainer==t.startContainer&&e.startOffset==t.startOffset&&e.endContainer==t.endContainer&&e.endOffset==t.endOffset:!1}},_innerText:{enumerable:!1,value:function(e){var t="",i=[],n="",a=!1,s=function(e){var t,o=e.nodeName;if(!o.match(/^(TITLE|STYLE|SCRIPT)$/)){for(a&&o.match(/^(P|DIV|BR|TR|LI)$/)&&(n+="\n"),t=e.firstChild;t;t=t.nextSibling)3==t.nodeType?(i.push(n+t.nodeValue),n="",a=!0):("BR"!=t.nodeName||t.nextSibling)&&s(t);a&&o.match(/^(TABLE|UL|OL)$/)&&(n+="\n")}};return e&&(s(e),t=i.join("")),t}},deserializedFromTemplate:{value:function(){this._originalDomContent=this.domContent}}})}});